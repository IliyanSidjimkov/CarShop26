@using System.Security.Claims
@model IEnumerable<AllCarsViewModel>

@{
    Layout = "_Layout";

    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var isAuthenticated = User.Identity?.IsAuthenticated == true;
}

<h2 class="mb-4">All Cars</h2>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">No cars available.</div>
}
else
{
    <div class="row">
        @foreach (var car in Model)
        {
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="@(string.IsNullOrWhiteSpace(car.ImageUrl)
                                                                              ? Url.Content("~/images/placeholder-car.png")
                                                                              : car.ImageUrl)"
                         onerror="this.onerror=null; this.src='@Url.Content("~/images/placeholder-car.png")';"
                         class="card-img-top"
                         style="height: 200px; object-fit: cover;"
                         alt="@(car.Brand) @(car.Model)" />

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@car.Brand @car.Model</h5>

                        <p class="card-text mb-1">
                            <strong>Price:</strong> @car.Price.ToString("N2") €
                        </p>

                        <p class="card-text mb-3">
                            <strong>Owner:</strong> @car.OwnerName
                        </p>

                        <div class="mt-auto d-flex gap-2 flex-wrap">

                            <a asp-controller="Car"
                               asp-action="Details"
                               asp-route-id="@car.Id"
                               asp-route-returnUrl="@Url.Action("AllCars", "Car")"
                               class="btn btn-outline-primary">
                                View Offer
                            </a>

                            @if (isAuthenticated && car.OwnerId == currentUserId)
                            {

                                <a class="btn btn-warning"
                                   href="@Url.Action("Edit", "Car", new { id = car.Id })">
                                    Edit
                                </a>

                                <form method="post"
                                      action="@Url.Action("Delete", "Car", new { id = car.Id })">

                                    <button type="submit" class="btn btn-danger">
                                        Delete
                                    </button>
                                </form>
                            }
                            else if (isAuthenticated)
                            {
                                if (car.isFavourite)
                                {
                                    <span class="badge bg-success align-self-center">
                                         Already in favourites
                                    </span>
                                }
                                else
                                {
                                    <form method="post"
                                          action="@Url.Action("AddToFavourites", "Favourites", new { carId = car.Id })">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger">
                                            Add to favourites
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
